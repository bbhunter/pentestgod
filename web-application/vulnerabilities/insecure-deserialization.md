---
description: Insecure Deserialization Vulnerabilities
---

# Insecure Deserialization

> Insecure deserialization is when user-controllable data is deserialized by a website. This potentially enables an attacker to manipulate serialized objects in order to pass harmful data into the application code.

### Java Deserialization

#### Identifying serialized data

Look for Java serialized data being sent to the server. Java binary serialized data starts with hex bytes "ac ed 00 05":

<figure><img src="../../.gitbook/assets/javadeser1 (1).png" alt=""><figcaption><p>HEX bytes of a Java serialized data</p></figcaption></figure>

In web applications, it might be encoded to base64. Look for b64 data starting with "rO0AB":

<figure><img src="../../.gitbook/assets/javadeser2.png" alt=""><figcaption><p>Base64 encoding of "ac ed 00 05".</p></figcaption></figure>

#### Exploiting

When approaching an application that utilizes serialized Java data, we do not know the libraries used by the backed. This is necessary for the exploitation. In that case, a brute-force approach might be rewarding (with all the payloads on [ysoserial](https://github.com/frohoff/ysoserial)):

{% code overflow="wrap" %}
```
while read payloadname; do java -jar /opt/ysoserial/ysoserial-master-SNAPSHOT.jar $payloadname "ping x.x.x.x -c 3" > $payloadname; done < payloads.txt 
```
{% endcode %}

If we already know the library being used, we can generate a payload like this:

```bash
java -jar ysoserial.jar CommonsCollections1 '<COMMAND_HERE>'
```

**Note:** Command parameters being passed as payload can not contain spaces.

#### URLDNS

Instead of providing RCE payloads directly, we can use the URLDNS payload to make the deserialization endpoint to resolve an arbitrary DNS name. It uses built-in Java features, so it is most likely to work almost in every case:

<figure><img src="../../.gitbook/assets/javadeser3.png" alt=""><figcaption><p>URLDNS Example</p></figcaption></figure>

#### Common errors

If we receive an Stacktrace while exploiting insecure deserialization, this might indicate:&#x20;

* **ClassNotFoundException:** Target application does not use the gadget library (payload) used. Try others.
* **Java.io.IOException with message "Cannot run program":** Payload worked, but the application is unavailable.&#x20;

#### Resources

* [Ysoserial](https://github.com/frohoff/ysoserial)&#x20;
* [Burp plugin – Freddy](https://portswigger.net/bappstore/ae1cce0c6d6c47528b4af35faebc3ab3) &#x20;
* [Burp plugin – Java Deserialization Scanner](https://portswigger.net/bappstore/228336544ebe4e68824b5146dbbd93ae) [(Tutorial)](https://techblog.mediaservice.net/2017/05/reliable-discovery-and-exploitation-of-java-deserialization-vulnerabilities/)&#x20;
* [Java Deserialization Cheatsheet](https://github.com/GrrrDog/Java-Deserialization-Cheat-Sheet)&#x20;
* [Java Deserialization Exploits](https://github.com/Coalfire-Research/java-deserialization-exploits)&#x20;
* [Java Deserialization tips](https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Insecure%20Deserialization/Java.md)&#x20;
